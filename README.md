# Redmine Projects Time Tracking Plugin

Плагин для Redmine, добавляющий метрики бюджета и времени в список проектов и на страницу обзора проекта.

## Возможности

- **Расширенный список проектов**: колонки Estimated Hours, Spent Time и метрики бюджета
- **Дашборд бюджета**: отображение метрик на странице проекта
- **История изменений**: автоматическое отслеживание изменений бюджета и дат проекта
- **Метрики EVM**: CPI, EAC, Variance по методологии Earned Value Management

## Требования

- Redmine 5.1+
- Ruby 2.7+

## Установка

```bash
# Перейти в директорию плагинов Redmine
cd /path/to/redmine/plugins

# Клонировать плагин
git clone <repository-url> redmineup_projects_time_tracking

# Запустить миграции
cd /path/to/redmine
bundle exec rake redmine:plugins:migrate RAILS_ENV=production

# Перезапустить Redmine
touch tmp/restart.txt
```

## Настройка

### 1. Создание кастомных полей

В **Администрирование > Настраиваемые поля > Проекты** создайте:

| Поле | Тип | Описание |
|------|-----|----------|
| Бюджет | Float/Integer | Бюджет проекта в часах |
| Начало проекта | Date | Плановая дата начала |
| Окончание проекта | Date | Плановая дата завершения |

### 2. Настройка плагина

В **Администрирование > Плагины > Redmineup Projects Time Tracking > Настроить**:

1. Выберите кастомные поля для бюджета и дат
2. Отметьте статусы, которые означают "Закрыто" (для расчёта E_closed)

### 3. Включение полей для проектов

Убедитесь, что кастомные поля включены для нужных проектов.

## Метрики

### Входные данные

| Символ | Название | Источник |
|--------|----------|----------|
| B | Budget | Кастомное поле бюджета |
| E_total | Total Estimates | Сумма оценок всех задач проекта |
| E_closed | Closed Estimates | Сумма оценок задач с закрытым статусом |
| F | Actual Hours | Фактические трудозатраты (time entries) |

### Расчётные метрики

| Метрика | Формула | Описание |
|---------|---------|----------|
| **Прогресс** | `E_closed / E_total × 100%` | % завершённой работы |
| **Освоение** | `F / B × 100%` | % израсходованного бюджета |
| **CPI** | `E_closed / F` | Cost Performance Index |
| **EAC** | `E_total / CPI` | Estimate at Completion |
| **Variance** | `B - EAC` | Отклонение от бюджета |

### Интерпретация CPI

| CPI | Статус | Значение |
|-----|--------|----------|
| ≥ 1.0 | Норма | По плану или экономия |
| 0.9 - 1.0 | Внимание | Небольшой перерасход |
| < 0.9 | Проблема | Значительный перерасход |

### Пример расчёта

```
Дано:
  B = 100 ч, E_total = 80 ч, E_closed = 40 ч, F = 50 ч

Расчёт:
  Прогресс = 40 / 80 × 100% = 50%
  Освоение = 50 / 100 × 100% = 50%
  CPI = 40 / 50 = 0.8 (проблема)
  EAC = 80 / 0.8 = 100 ч
  Variance = 100 - 100 = 0 ч

Вывод: 50% работы выполнено, 50% бюджета израсходовано,
       но CPI = 0.8 показывает 20% перерасход.
```

## Цветовая индикация

| Цвет | Метрика | Условие |
|------|---------|---------|
| Серый | Строка проекта | Есть списания, но нет бюджета |
| Красный | Освоение | > 100% |
| Красный | CPI | < 0.9 |
| Жёлтый | CPI | 0.9 - 1.0 |
| Зелёный | CPI | ≥ 1.0 |
| Красный | Variance | < 0 (дефицит) |
| Зелёный | Variance | > 0 (профицит) |

## Структура базы данных

### Таблица `ptt_project_histories`

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | integer | PK |
| project_id | integer | FK → projects |
| user_id | integer | FK → users |
| field_name | string | budget, start_date, end_date |
| old_value | string | Предыдущее значение |
| new_value | string | Новое значение |
| created_at | datetime | Время изменения |

**Индексы**: project_id, user_id, created_at

## Удаление

```bash
# Откатить миграции
cd /path/to/redmine
bundle exec rake redmine:plugins:migrate NAME=redmineup_projects_time_tracking VERSION=0 RAILS_ENV=production

# Удалить плагин
rm -rf plugins/redmineup_projects_time_tracking

# Перезапустить Redmine
touch tmp/restart.txt
```

## Лицензия

MIT License

## Changelog

### 0.3.0
- Добавлена пагинация истории изменений
- Добавлена валидация настроек плагина
- Рефакторинг: вынесены helper-методы для устранения дублирования
- Добавлена XSS-защита для тултипов
- Добавлен индекс на user_id в таблице истории
- Добавлена валидация field_name в модели PttProjectHistory

### 0.2.0
- Добавлено отслеживание истории изменений бюджета и дат
- Добавлен блок метрик на странице проекта

### 0.1.0
- Начальная версия
- Колонки времени в списке проектов
- Расчёт метрик бюджета
