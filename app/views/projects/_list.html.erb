<% @admin_list = User.current.admin? && controller_name == 'admin' && action_name == 'projects' %>
<%= render_query_totals(@query) %>
<%
  # PATCHED - Preload data for all projects (optimized queries using helpers)
  project_ids = entries.map(&:id)
  budget_cf_id = ptt_budget_custom_field_id

  # Batch queries via helpers
  ptt_budgets = ptt_budgets_for_projects(project_ids)
  ptt_issues_data = ptt_issues_data_for_projects(project_ids)
  ptt_time_spent = ptt_time_spent_for_projects(project_ids)

  # Load histories for all projects (for highlighting custom fields)
  ptt_all_histories = ptt_histories_for_projects(project_ids)
  ptt_tracked_cf_ids = ptt_cf_to_field_mapping.keys
  # /PATCHED
%>
<%= form_tag({}, data: {cm_url: projects_context_menu_path}) do -%>
  <%= hidden_field_tag 'back_url', url_for(params: request.query_parameters), id: nil %>
  <div class="autoscroll ptt-table-scroll">
    <table class="list projects odd-even <%= @query.css_classes %>">
      <thead>
      <tr>
        <% if @admin_list %>
          <th class="checkbox hide-when-print">
            <%= check_box_tag 'check_all', '', false, :class => 'toggle-selection',
                              :title => "#{l(:button_check_all)} / #{l(:button_uncheck_all)}" %>
          </th>
        <% end %>
        <% @query.inline_columns.each do |column| %>
          <%= column_header(@query, column) %>
        <% end %>
        <% if @admin_list %>
          <th></th>
        <% end %>
        <% # PATCHED - Headers for time tracking columns %>
        <th><%= l(:field_estimated_hours) %></th>
        <th><%= l(:label_spent_time) %></th>
        <% if budget_cf_id %>
          <th title="% выполнения работы (E_closed / E_total)">Прогресс</th>
          <th title="% расхода бюджета (F / B)">Освоение</th>
          <th title="CPI = E_closed / F (≥1 норма, <0.9 проблема)">CPI</th>
          <th title="Прогноз итоговых затрат (E_total / CPI)">EAC</th>
          <th title="Отклонение от бюджета (B - EAC)">Variance</th>
        <% end %>
        <% # /PATCHED %>
      </tr>
      </thead>
      <tbody>
      <% grouped_project_list(entries, @query) do |entry, level, group_name, group_count, group_totals| -%>
        <% if group_name %>
          <% reset_cycle %>
          <tr class="group open">
            <td colspan="<%= @query.inline_columns.size + 2 + (budget_cf_id ? 5 : 0) %>">
              <span class="expander icon icon-expanded" onclick="toggleRowGroup(this);">&nbsp;</span>
              <span class="name"><%= group_name %></span>
              <% if group_count %>
                <span class="count"><%= group_count %></span>
              <% end %>
              <span class="totals"><%= group_totals %></span>
              <%= link_to_function("#{l(:button_collapse_all)}/#{l(:button_expand_all)}",
                                   "toggleAllRowGroups(this)", :class => 'toggle-all') %>
            </td>
            <% if @admin_list %>
              <td></td>
            <% end %>
          </tr>
        <% end %>
        <%
          # Check if project has spent time but no budget configured
          ptt_entry_spent = ptt_time_spent[entry.id] || 0
          ptt_entry_budget = ptt_budgets[entry.id]
          ptt_no_budget = budget_cf_id && ptt_entry_spent > 0 && (ptt_entry_budget.nil? || ptt_entry_budget <= 0)
        %>
        <tr id="project-<%= entry.id %>" class="<%= cycle('odd', 'even') %> hascontextmenu <%= entry.css_classes %> <%= level > 0 ? "idnt idnt-#{level}" : nil %> <%= 'ptt-no-budget' if ptt_no_budget %>">
          <% if @admin_list %>
            <% if !entry.scheduled_for_deletion? %>
              <td class="checkbox hide-when-print"><%= check_box_tag("ids[]", entry.id, false, :id => nil) %></td>
            <% else %>
              <td class="checkbox hide-when-print"></td>
            <% end %>
          <% end %>
          <%
            # Get project histories for highlighting
            ptt_project_hist = ptt_all_histories[entry.id]
          %>
          <% @query.inline_columns.each do |column| %>
            <%
              # Check if column is a tracked custom field with history
              cf_id = column.name.to_s.start_with?('cf_') ? column.name.to_s.sub('cf_', '') : nil
              has_history = cf_id && ptt_tracked_cf_ids.include?(cf_id) &&
                            User.current.allowed_to?(:view_time_entries, entry) &&
                            ptt_cf_has_history?(ptt_project_hist, cf_id)
              history_class = has_history ? ptt_cf_history_class(ptt_project_hist, cf_id) : nil
              history_title = has_history ? ptt_cf_history_tooltip(ptt_project_hist, cf_id) : nil
            %>
            <% if has_history %>
              <td class="<%= column.css_classes %> <%= history_class %>" title="<%= h(history_title) %>">
                <%= column_content(column, entry) %>
              </td>
            <% else %>
              <%= content_tag('td', column_content(column, entry), :class => column.css_classes) %>
            <% end %>
          <% end %>
          <% # PATCHED - Time tracking and metrics columns %>
          <% if User.current.allowed_to?(:view_time_entries, entry) %>
            <%
              ptt_project_issues = ptt_issues_data[entry.id] || ptt_empty_issues_data
              ptt_spent = ptt_time_spent[entry.id] || 0
              ptt_estimated = ptt_project_issues[:estimated]
              ptt_budget = ptt_budgets[entry.id]
              ptt_metrics = project_metrics(ptt_budget, ptt_project_issues, ptt_spent)
            %>
            <%= content_tag('td', format_metric_hours(ptt_estimated)) %>
            <%= content_tag('td', format_metric_hours(ptt_spent), class: (ptt_estimated < ptt_spent ? 'ptt-overbudget' : nil)) %>
            <% if budget_cf_id %>
              <% if ptt_metrics %>
                <td title="<%= h(metric_tooltip(:progress, ptt_metrics)) %>">
                  <%= format_metric_percent(ptt_metrics[:progress]) %>
                </td>
                <td title="<%= h(metric_tooltip(:spent, ptt_metrics)) %>"
                    class="<%= metric_css_class(:spent, ptt_metrics[:spent]) %>">
                  <%= format_metric_percent(ptt_metrics[:spent]) %>
                </td>
                <td title="<%= h(metric_tooltip(:cpi, ptt_metrics)) %>"
                    class="<%= metric_css_class(:cpi, ptt_metrics[:cpi]) %>">
                  <%= number_with_precision(ptt_metrics[:cpi], precision: 2) %>
                </td>
                <td title="<%= h(metric_tooltip(:eac, ptt_metrics)) %>">
                  <%= format_metric_hours(ptt_metrics[:eac]) %>
                </td>
                <td title="<%= h(metric_tooltip(:variance, ptt_metrics)) %>"
                    class="<%= metric_css_class(:variance, ptt_metrics[:variance]) %>">
                  <%= format_metric_hours(ptt_metrics[:variance]) %>
                </td>
              <% else %>
                <td colspan="5" style="text-align: center; color: #999;" title="Бюджет не задан — метрики недоступны">—</td>
              <% end %>
            <% end %>
          <% else %>
            <td></td>
            <td></td>
            <% if budget_cf_id %>
              <td colspan="5"></td>
            <% end %>
          <% end %>
          <% # /PATCHED %>
          <% if @admin_list %>
            <% if !entry.scheduled_for_deletion? %>
              <td class="buttons"><%= link_to_context_menu %></td>
            <% else %>
              <td class="buttons"></td>
            <% end %>
          <% end %>
        </tr>
      <% end -%>
      </tbody>
    </table>
  </div>
<% end -%>
<span class="pagination"><%= pagination_links_full @entry_pages, @entry_count %></span>

<div id="csv-export-options" style="display:none;">
  <h3 class="title"><%= l(:label_export_options, :export_format => 'CSV') %></h3>
  <%= form_tag(projects_path(:format => 'csv'), :method => :get, :id => 'csv-export-form') do %>
    <%= query_as_hidden_field_tags(@query) %>
    <p>
      <label><%= radio_button_tag 'c[]', '', true %> <%= l(:description_selected_columns) %></label><br />
      <label><%= radio_button_tag 'c[]', 'all_inline' %> <%= l(:description_all_columns) %></label>
    </p>
    <%= export_csv_encoding_select_tag %>
    <%= export_csv_separator_select_tag %>
    <p class="buttons">
      <%= submit_tag l(:button_export), :name => nil, :onclick => "hideModal(this);", :data => { :disable_with => false } %>
      <%= link_to_function l(:button_cancel), "hideModal(this);" %>
    </p>
  <% end %>
</div>
<%= context_menu if @admin_list %>
