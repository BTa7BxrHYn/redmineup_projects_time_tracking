<%
  # Show history with pagination
  ptt_history_limit = ProjectsTimeTrackingHelper::PTT_HISTORY_LIMIT
  ptt_show_all = params[:ptt_show_all_history] == '1'

  base_query = @project.ptt_histories.sorted
  ptt_total_count = base_query.count

  if ptt_total_count > 0
    histories_to_show = ptt_show_all ? base_query.includes(:user) : base_query.includes(:user).limit(ptt_history_limit)

    # Group history entries by timestamp (within 1 minute = same "journal")
    grouped_histories = histories_to_show.group_by do |h|
      [h.user_id, h.created_at.to_i / 60]
    end
%>

<div id="ptt-history" class="box">
  <h3 class="icon icon-history">
    История изменений
    <% if ptt_total_count > ptt_history_limit && !ptt_show_all %>
      <span style="font-weight: normal; font-size: 0.85em; color: #666;">
        (последние <%= ptt_history_limit %> из <%= ptt_total_count %>)
      </span>
    <% end %>
  </h3>

  <% grouped_histories.each do |(user_id, time_key), entries| %>
    <% entry = entries.first %>
    <div class="journal" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-left: 3px solid #ccc;">
      <div style="margin-bottom: 8px; color: #666;">
        <strong><%= link_to_user(entry.user) %></strong>
        —
        <%= format_time(entry.created_at) %>
      </div>
      <ul class="details" style="margin: 0; padding-left: 20px;">
        <% entries.each do |h| %>
          <li>
            <strong><%= h.field_label %></strong>:
            <% if h.old_value.present? %>
              <del style="color: #900; background: #fdd;"><%= h.formatted_old_value %></del>
              →
            <% end %>
            <ins style="color: #090; background: #dfd;"><%= h.formatted_new_value %></ins>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% if ptt_total_count > ptt_history_limit %>
    <p style="text-align: center; margin: 10px 0 0;">
      <% if ptt_show_all %>
        <%= link_to 'Показать последние', project_path(@project), class: 'icon icon-collapsed' %>
      <% else %>
        <%= link_to "Показать все #{ptt_total_count} изменений", project_path(@project, ptt_show_all_history: '1'), class: 'icon icon-expanded' %>
      <% end %>
    </p>
  <% end %>
</div>

<% end %>
