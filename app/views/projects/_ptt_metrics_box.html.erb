<%
  # Only show if budget field is configured and user can view time entries
  budget_cf_id = ptt_budget_custom_field_id

  if budget_cf_id && User.current.allowed_to?(:view_time_entries, @project)
    # Get data using helpers
    ptt_budget = ptt_budget_for_project(@project)

    if ptt_budget && ptt_budget > 0
      ptt_project_issues = ptt_issues_data_for_project(@project)
      ptt_e_total = ptt_project_issues[:estimated]
      ptt_e_closed = ptt_project_issues[:closed_estimated]
      ptt_spent = ptt_time_spent_for_project(@project)

      # Calculate metrics
      ptt_metrics = project_metrics(ptt_budget, ptt_project_issues, ptt_spent)
%>

<h3><%= l(:label_spent_time) %> / Бюджет</h3>
<ul class="properties">
  <li>
    <span class="label">Бюджет (B):</span>
    <span class="value"><strong><%= format_metric_hours(ptt_budget) %></strong> ч</span>
  </li>
  <li>
    <span class="label">Оценки (E_total):</span>
    <span class="value"><%= format_metric_hours(ptt_e_total) %> ч</span>
  </li>
  <li>
    <span class="label">Закрыто (E_closed):</span>
    <span class="value"><%= format_metric_hours(ptt_e_closed) %> ч</span>
  </li>
  <li>
    <span class="label">Факт (F):</span>
    <span class="value"><%= format_metric_hours(ptt_spent) %> ч</span>
  </li>
  <% if ptt_metrics %>
    <li title="<%= h(metric_tooltip(:progress, ptt_metrics)) %>">
      <span class="label">Прогресс:</span>
      <span class="value"><%= format_metric_percent(ptt_metrics[:progress]) %></span>
    </li>
    <li title="<%= h(metric_tooltip(:spent, ptt_metrics)) %>"
        style="<%= "background-color: #{metric_color(:spent, ptt_metrics[:spent])};" if metric_color(:spent, ptt_metrics[:spent]) %>">
      <span class="label">Освоение:</span>
      <span class="value"><%= format_metric_percent(ptt_metrics[:spent]) %></span>
    </li>
    <li title="<%= h(metric_tooltip(:cpi, ptt_metrics)) %>"
        style="<%= "background-color: #{metric_color(:cpi, ptt_metrics[:cpi])};" if metric_color(:cpi, ptt_metrics[:cpi]) %>">
      <span class="label">CPI:</span>
      <span class="value">
        <%= cpi_status(ptt_metrics[:cpi])[:icon] %>
        <strong><%= number_with_precision(ptt_metrics[:cpi], precision: 2) %></strong>
      </span>
    </li>
    <li title="<%= h(metric_tooltip(:eac, ptt_metrics)) %>">
      <span class="label">EAC (прогноз):</span>
      <span class="value"><%= format_metric_hours(ptt_metrics[:eac]) %> ч</span>
    </li>
    <li title="<%= h(metric_tooltip(:variance, ptt_metrics)) %>"
        style="<%= "background-color: #{metric_color(:variance, ptt_metrics[:variance])};" if metric_color(:variance, ptt_metrics[:variance]) %>">
      <span class="label">Variance:</span>
      <span class="value">
        <%= ptt_metrics[:variance] >= 0 ? '+' : '' %><%= format_metric_hours(ptt_metrics[:variance]) %> ч
        (<%= format_metric_percent(ptt_metrics[:variance_percent]) %>)
      </span>
    </li>
  <% end %>
</ul>

<%
    end
  end
%>
